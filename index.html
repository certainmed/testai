<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindSpark AI - Kuis & Flashcard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Typography */
        h1, h2, h3, h4, .brand-font { font-family: 'Playfair Display', serif; }
        body, input, button, textarea, div { font-family: 'Lato', sans-serif; }

        /* Animation */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }

        .ai-gradient {
            background: linear-gradient(270deg, #4F46E5, #9333ea, #ec4899);
            background-size: 200% 200%;
            animation: sparkle 3s ease infinite;
        }
        @keyframes sparkle { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col overflow-x-hidden">

    <!-- Header -->
    <header class="bg-white shadow-md py-4 px-6 fixed w-full z-20 top-0">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="app.showScreen('home')">
                <i class="fa-solid fa-brain text-indigo-600 text-2xl"></i>
                <span class="text-2xl font-bold brand-font text-gray-800">MindSpark <span class="text-purple-500">AI</span></span>
            </div>
            
            <div class="flex items-center space-x-3">
                <!-- Settings Button -->
                <button onclick="app.toggleSettings()" class="text-gray-500 hover:text-indigo-600 transition p-2 rounded-full hover:bg-gray-100">
                    <i class="fa-solid fa-gear text-xl"></i>
                </button>
                
                <div id="header-controls" class="hidden flex items-center space-x-3">
                    <div id="timer-display" class="bg-red-100 text-red-600 px-3 py-1 rounded-full font-bold hidden text-sm border border-red-200">
                        <i class="fa-regular fa-clock mr-1"></i><span id="time-value">00:00</span>
                    </div>
                    <button onclick="app.showScreen('home')" class="text-gray-500 hover:text-red-500 transition font-bold text-sm">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Settings Modal (For API Key) -->
    <div id="modal-settings" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
            <div class="bg-gray-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold flex items-center"><i class="fa-solid fa-key mr-2"></i> Pengaturan API</h3>
                <button onclick="app.toggleSettings()" class="hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">Masukkan Google Gemini API Key Anda agar fitur AI dapat berjalan.</p>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Gemini API Key</label>
                <div class="relative">
                    <input type="password" id="input-api-key" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none pr-10 text-sm" placeholder="Paste kunci AIza... disini">
                    <button onclick="app.toggleShowApiKey()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-eye" id="icon-eye"></i>
                    </button>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-600 hover:underline">Dapatkan API Key disini &rarr;</a>
                    <button onclick="app.saveApiKey()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold text-sm transition shadow-lg">
                        Simpan
                    </button>
                </div>
                <p id="api-status" class="text-xs text-center mt-3 text-gray-400 italic"></p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow pt-24 pb-10 px-4">
        <div class="max-w-4xl mx-auto">
            
            <!-- 1. Home Screen -->
            <div id="screen-home" class="text-center py-10">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 brand-font">Belajar Pintar dengan AI</h1>
                <p class="text-lg text-gray-600 mb-10 max-w-2xl mx-auto">Upload materi atau biarkan <span class="text-indigo-600 font-bold">Gemini AI</span> membuatkan soal.</p>
                
                <div class="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                    <!-- Quiz Card -->
                    <div onclick="app.selectMode('quiz')" class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl cursor-pointer border-t-4 border-indigo-600 group transition hover:-translate-y-1">
                        <div class="w-14 h-14 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-indigo-600 transition">
                            <i class="fa-solid fa-clipboard-question text-2xl text-indigo-600 group-hover:text-white"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-1">Mode Kuis</h2>
                        <p class="text-sm text-gray-500">Pilihan ganda, skor & timer.</p>
                    </div>

                    <!-- Flashcard Card -->
                    <div onclick="app.selectMode('flashcard')" class="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl cursor-pointer border-t-4 border-emerald-500 group transition hover:-translate-y-1">
                        <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-emerald-500 transition">
                            <i class="fa-solid fa-layer-group text-2xl text-emerald-500 group-hover:text-white"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-1">Flashcard</h2>
                        <p class="text-sm text-gray-500">Hafalan cepat kartu bolak-balik.</p>
                    </div>
                </div>
            </div>

            <!-- 2. Upload / Generate Screen -->
            <div id="screen-upload" class="hidden max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <button onclick="app.showScreen('home')" class="mb-6 text-gray-500 hover:text-gray-800 text-sm font-bold flex items-center"><i class="fa-solid fa-arrow-left mr-2"></i> Kembali</button>
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 brand-font">Sumber Materi</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- AI Generator -->
                    <div class="bg-purple-50 p-6 rounded-xl border border-purple-100 flex flex-col">
                        <div class="flex items-center mb-3 text-purple-700">
                            <i class="fa-solid fa-wand-magic-sparkles text-xl mr-2"></i>
                            <h3 class="text-lg font-bold">Generate Otomatis</h3>
                        </div>
                        <textarea id="ai-topic-input" class="w-full p-3 border border-purple-200 rounded-lg text-sm mb-4 h-32 resize-none focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Contoh: 'Tata Surya', 'Rumus Kimia Dasar', atau paste teks materi..."></textarea>
                        <button onclick="app.generateWithAI()" class="mt-auto w-full ai-gradient text-white font-bold py-3 rounded-lg shadow hover:opacity-90 transition flex justify-center items-center">
                            <i class="fa-solid fa-bolt mr-2"></i> Buat Soal AI
                        </button>
                    </div>

                    <!-- Manual Upload -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col">
                        <div class="flex items-center mb-3 text-gray-700">
                            <i class="fa-solid fa-file-arrow-up text-xl mr-2"></i>
                            <h3 class="text-lg font-bold">Upload JSON</h3>
                        </div>
                        <div class="border-2 border-dashed border-gray-300 rounded-xl flex-grow flex flex-col items-center justify-center p-4 bg-white relative hover:border-indigo-400 transition cursor-pointer">
                            <input type="file" id="file-input" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="app.handleFile(this.files[0])">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-2"></i>
                            <p class="text-xs text-gray-500">Klik / Drop File JSON</p>
                        </div>
                        <button onclick="app.downloadTemplate()" class="mt-4 w-full bg-white border border-gray-300 text-gray-600 font-bold py-2 rounded-lg text-sm hover:bg-gray-100"><i class="fa-solid fa-download mr-1"></i> Template</button>
                    </div>
                </div>
            </div>

            <!-- 3. Quiz Setup -->
            <div id="screen-setup-quiz" class="hidden max-w-lg mx-auto bg-white p-8 rounded-2xl shadow-lg border-t-4 border-indigo-600">
                <h2 class="text-2xl font-bold mb-2 text-center brand-font">Pengaturan</h2>
                <p class="text-center text-indigo-600 font-bold mb-6 bg-indigo-50 py-2 rounded" id="question-count-display">0 Soal</p>
                
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Timer (Opsional)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center"><input type="number" id="t-hours" placeholder="0" class="w-full p-2 border rounded text-center font-bold"><span class="text-[10px] uppercase text-gray-500">Jam</span></div>
                        <div class="text-center"><input type="number" id="t-minutes" placeholder="0" class="w-full p-2 border rounded text-center font-bold"><span class="text-[10px] uppercase text-gray-500">Menit</span></div>
                        <div class="text-center"><input type="number" id="t-seconds" placeholder="0" class="w-full p-2 border rounded text-center font-bold"><span class="text-[10px] uppercase text-gray-500">Detik</span></div>
                    </div>
                </div>
                <button onclick="app.startQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition">Mulai Kuis</button>
            </div>

            <!-- 4. Quiz Play -->
            <div id="screen-quiz" class="hidden max-w-3xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div class="w-full bg-gray-200 h-1.5"><div id="quiz-progress" class="bg-indigo-600 h-1.5 transition-all duration-300" style="width: 0%"></div></div>
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-xs font-bold text-gray-400 uppercase">Soal <span id="current-q-num">1</span>/<span id="total-q-num">10</span></span>
                            <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded font-bold" id="score-live">Skor: 0</span>
                        </div>
                        <h3 id="question-text" class="text-xl md:text-2xl font-bold text-gray-800 mb-6 brand-font">Loading...</h3>
                        <div id="options-container" class="space-y-3"></div>
                    </div>
                    <div class="bg-gray-50 px-8 py-4 border-t flex justify-between items-center">
                        <button id="btn-ai-explain" onclick="app.explainWithAI()" class="hidden text-purple-600 text-sm font-bold hover:bg-purple-100 px-3 py-1 rounded transition border border-purple-200"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Penjelasan AI</button>
                        <button id="btn-next-q" onclick="app.nextQuestion()" class="bg-gray-800 hover:bg-black text-white px-6 py-2 rounded-lg font-bold text-sm ml-auto hidden">Lanjut &rarr;</button>
                    </div>
                </div>
            </div>

            <!-- 5. Flashcard Play -->
            <div id="screen-flashcard" class="hidden max-w-xl mx-auto flex flex-col items-center min-h-[50vh] justify-center">
                <div class="w-full text-center mb-4"><span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-3 py-1 rounded-full" id="flashcard-counter">1 / 10</span></div>
                <div class="perspective-1000 w-full h-80 cursor-pointer group" onclick="app.flipCard()">
                    <div id="flashcard-inner" class="relative w-full h-full text-center transition-transform duration-500 transform-style-3d shadow-xl rounded-2xl">
                        <div class="absolute w-full h-full backface-hidden bg-white border border-gray-200 rounded-2xl flex flex-col items-center justify-center p-6"><h3 id="fc-front" class="text-2xl font-bold text-gray-800 brand-font">?</h3><p class="text-xs text-gray-400 absolute bottom-4">Klik balik</p></div>
                        <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-2xl flex flex-col items-center justify-center p-6"><h3 id="fc-back" class="text-2xl font-bold brand-font">!</h3></div>
                    </div>
                </div>
                <div class="flex space-x-4 mt-8">
                    <button onclick="app.prevFlashcard()" class="w-12 h-12 rounded-full bg-white shadow text-gray-600 hover:text-emerald-500 flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></button>
                    <button onclick="app.shuffleFlashcards()" class="px-4 bg-gray-200 rounded-lg text-sm font-bold text-gray-700 hover:bg-gray-300">Acak</button>
                    <button onclick="app.nextFlashcard()" class="w-12 h-12 rounded-full bg-white shadow text-gray-600 hover:text-emerald-500 flex items-center justify-center"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>

            <!-- 6. Result -->
            <div id="screen-result" class="hidden text-center pt-10">
                <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-md mx-auto">
                    <i class="fa-solid fa-trophy text-6xl text-yellow-400 mb-4 block animate-bounce"></i>
                    <h2 class="text-3xl font-bold mb-2 brand-font">Selesai!</h2>
                    <div class="flex justify-center space-x-4 my-6">
                        <div class="bg-indigo-50 p-3 rounded-xl w-24"><span class="block text-xs text-indigo-400 font-bold uppercase">Skor</span><span class="text-2xl font-bold text-indigo-700" id="res-score">0</span></div>
                        <div class="bg-green-50 p-3 rounded-xl w-24"><span class="block text-xs text-green-400 font-bold uppercase">Benar</span><span class="text-2xl font-bold text-green-700" id="res-correct">0</span></div>
                    </div>
                    <button onclick="app.showScreen('home')" class="w-full bg-gray-900 text-white py-3 rounded-xl font-bold hover:bg-black">Main Lagi</button>
                </div>
            </div>

        </div>
    </main>

    <!-- Overlay Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm text-white">
        <div class="loader mb-4 border-t-white"></div>
        <p id="loading-text" class="font-bold tracking-wide">AI Sedang Bekerja...</p>
    </div>

    <!-- Modal AI Explanation -->
    <div id="modal-explanation" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
            <div class="bg-purple-600 p-4 text-white flex justify-between items-center rounded-t-2xl">
                <h3 class="font-bold"><i class="fa-solid fa-robot mr-2"></i> Penjelasan AI</h3>
                <button onclick="document.getElementById('modal-explanation').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto" id="explanation-content"></div>
        </div>
    </div>

    <!-- Toast Error -->
    <div id="toast" class="fixed bottom-5 right-5 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all z-50 font-bold text-sm flex items-center">
        <i class="fa-solid fa-triangle-exclamation mr-2"></i> <span id="toast-msg">Error</span>
    </div>

    <script>
        const app = {
            data: [], currentMode: null, currentIndex: 0, score: 0, timer: null, timerSeconds: 0,
            apiKey: localStorage.getItem('gemini_api_key') || "", // Load from storage

            init: function() {
                this.showScreen('home');
            },

            // --- Settings & API Key ---
            toggleSettings: function() {
                const modal = document.getElementById('modal-settings');
                modal.classList.toggle('hidden');
                if(!modal.classList.contains('hidden')) {
                    document.getElementById('input-api-key').value = this.apiKey;
                    document.getElementById('api-status').innerText = "";
                }
            },
            
            toggleShowApiKey: function() {
                const input = document.getElementById('input-api-key');
                const icon = document.getElementById('icon-eye');
                if(input.type === "password") {
                    input.type = "text";
                    icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
                } else {
                    input.type = "password";
                    icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
                }
            },

            saveApiKey: function() {
                const key = document.getElementById('input-api-key').value.trim();
                if(!key) {
                    document.getElementById('api-status').innerText = "Key tidak boleh kosong!";
                    document.getElementById('api-status').className = "text-xs text-center mt-3 text-red-500 font-bold";
                    return;
                }
                this.apiKey = key;
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('api-status').innerText = "Tersimpan! Silakan tutup menu ini.";
                document.getElementById('api-status').className = "text-xs text-center mt-3 text-green-600 font-bold";
                setTimeout(() => this.toggleSettings(), 1500);
            },

            // --- AI Logic ---
            callGemini: async function(prompt) {
                if(!this.apiKey) {
                    this.toggleSettings();
                    throw new Error("API Key belum disetting! Masukkan key di menu gerigi.");
                }

                // Using strict model name from instructions
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.apiKey}`;
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        // Detailed error handling
                        const errMsg = result.error?.message || "Gagal menghubungi AI";
                        throw new Error(`API Error: ${errMsg}`);
                    }

                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Gemini Error:", error);
                    throw error;
                }
            },

            generateWithAI: async function() {
                const topic = document.getElementById('ai-topic-input').value.trim();
                if (!topic) return this.showToast("Topik tidak boleh kosong");

                this.setLoading(true, "AI sedang membuat soal...");

                try {
                    let prompt = "";
                    if (this.currentMode === 'quiz') {
                        prompt = `Buatkan 10 soal kuis pilihan ganda tentang topik "${topic}" dalam Bahasa Indonesia. 
                        Output wajib JSON murni tanpa markdown. Format: 
                        [{"question": "Pertanyaan?", "options": ["A", "B", "C", "D"], "answer": "Jawaban Benar (harus sama persis dengan salah satu opsi)"}]`;
                    } else {
                        prompt = `Buatkan 10 flashcard tentang topik "${topic}" dalam Bahasa Indonesia. 
                        Output wajib JSON murni tanpa markdown. Format: 
                        [{"question": "Depan", "answer": "Belakang"}]`;
                    }

                    let text = await this.callGemini(prompt);
                    // Cleaning markdown blocks usually returned by LLMs
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    const json = JSON.parse(text);
                    this.data = json;

                    document.getElementById('ai-topic-input').value = ""; // Clear
                    
                    if (this.currentMode === 'quiz') {
                        document.getElementById('question-count-display').innerText = `${this.data.length} Soal AI`;
                        this.showScreen('setup-quiz');
                    } else {
                        this.startFlashcard();
                    }
                } catch (e) {
                    this.showToast(e.message);
                } finally {
                    this.setLoading(false);
                }
            },

            explainWithAI: async function() {
                const q = this.data[this.currentIndex];
                const modal = document.getElementById('modal-explanation');
                const content = document.getElementById('explanation-content');
                
                modal.classList.remove('hidden');
                content.innerHTML = '<div class="text-center py-10"><div class="loader mx-auto border-purple-600"></div><p class="mt-4 text-gray-500">Menganalisis jawaban...</p></div>';

                try {
                    const prompt = `Jelaskan singkat padat (maks 2 paragraf) kenapa jawaban untuk "${q.question}" adalah "${q.answer}". Bahasa Indonesia.`;
                    const text = await this.callGemini(prompt);
                    content.innerHTML = marked.parse(text);
                } catch (e) {
                    content.innerHTML = `<p class="text-red-500 text-center font-bold">${e.message}</p>`;
                }
            },

            // --- Navigation & Core ---
            showScreen: function(id) {
                document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('screen-' + id).classList.remove('hidden');
                const controls = document.getElementById('header-controls');
                if(id === 'home') { controls.classList.add('hidden'); this.stopTimer(); }
                else controls.classList.remove('hidden');
            },

            selectMode: function(mode) { this.currentMode = mode; this.showScreen('upload'); },
            
            setLoading: function(show, text) {
                const el = document.getElementById('loading-overlay');
                if(show) { el.classList.remove('hidden'); if(text) document.getElementById('loading-text').innerText = text; } 
                else el.classList.add('hidden');
            },

            showToast: function(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 4000);
            },

            // --- File & Quiz Logic (Simplified for brevity as core logic is same) ---
            handleFile: function(file) {
                if(!file) return;
                const r = new FileReader();
                r.onload = (e) => {
                    try {
                        this.data = JSON.parse(e.target.result);
                        if(this.currentMode === 'quiz') {
                            document.getElementById('question-count-display').innerText = `${this.data.length} Soal Upload`;
                            this.showScreen('setup-quiz');
                        } else this.startFlashcard();
                    } catch(err) { this.showToast("File JSON Rusak"); }
                };
                r.readAsText(file);
            },
            
            downloadTemplate: function() {
                const t = [{"question":"Contoh Soal?","options":["A","B","C","D"],"answer":"A"}];
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(t));
                a.download = "template.json"; document.body.appendChild(a); a.click(); a.remove();
            },

            startQuiz: function() {
                const h = parseInt(document.getElementById('t-hours').value)||0, m = parseInt(document.getElementById('t-minutes').value)||0, s = parseInt(document.getElementById('t-seconds').value)||0;
                this.timerSeconds = (h*3600)+(m*60)+s;
                this.currentIndex=0; this.score=0;
                document.getElementById('score-live').innerText="Skor: 0";
                this.showScreen('quiz');
                if(this.timerSeconds > 0) {
                    document.getElementById('timer-display').classList.remove('hidden');
                    this.timer = setInterval(() => {
                        this.timerSeconds--;
                        const dh=Math.floor(this.timerSeconds/3600), dm=Math.floor((this.timerSeconds%3600)/60), ds=this.timerSeconds%60;
                        document.getElementById('time-value').innerText = `${dh}:${dm.toString().padStart(2,'0')}:${ds.toString().padStart(2,'0')}`;
                        if(this.timerSeconds<=0) { clearInterval(this.timer); this.finishQuiz(); }
                    }, 1000);
                } else document.getElementById('timer-display').classList.add('hidden');
                this.renderQuestion();
            },

            renderQuestion: function() {
                const q = this.data[this.currentIndex];
                document.getElementById('current-q-num').innerText = this.currentIndex+1;
                document.getElementById('total-q-num').innerText = this.data.length;
                document.getElementById('quiz-progress').style.width = `${((this.currentIndex+1)/this.data.length)*100}%`;
                document.getElementById('question-text').innerText = q.question;
                
                const c = document.getElementById('options-container'); c.innerHTML='';
                document.getElementById('btn-next-q').classList.add('hidden');
                document.getElementById('btn-ai-explain').classList.add('hidden');

                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 border border-gray-200 rounded-xl hover:bg-indigo-50 transition flex items-center group";
                    btn.onclick = () => this.checkAnswer(btn, opt, q.answer);
                    btn.innerHTML = `<span class="w-8 h-8 rounded bg-gray-100 text-gray-500 flex items-center justify-center mr-3 font-bold group-hover:bg-indigo-500 group-hover:text-white transition">${"ABCD"[idx]}</span> ${opt}`;
                    c.appendChild(btn);
                });
            },

            checkAnswer: function(btn, sel, corr) {
                document.querySelectorAll('#options-container button').forEach(b => b.disabled=true);
                if(sel===corr) {
                    this.score+=10; btn.className = "w-full text-left p-4 border border-green-500 bg-green-50 rounded-xl flex items-center";
                    document.getElementById('score-live').innerText = "Skor: "+this.score;
                } else {
                    btn.className = "w-full text-left p-4 border border-red-500 bg-red-50 rounded-xl flex items-center";
                }
                document.getElementById('btn-next-q').classList.remove('hidden');
                document.getElementById('btn-ai-explain').classList.remove('hidden');
            },

            nextQuestion: function() {
                if(++this.currentIndex < this.data.length) this.renderQuestion();
                else this.finishQuiz();
            },
            
            stopTimer: function() { if(this.timer) clearInterval(this.timer); },
            finishQuiz: function() {
                this.stopTimer(); this.showScreen('result');
                document.getElementById('res-score').innerText = this.score;
                document.getElementById('res-correct').innerText = this.score/10;
            },

            startFlashcard: function() { this.currentIndex=0; this.showScreen('flashcard'); this.renderFlashcard(); },
            renderFlashcard: function() {
                const c = this.data[this.currentIndex];
                document.getElementById('flashcard-inner').classList.remove('rotate-y-180');
                setTimeout(() => {
                    document.getElementById('fc-front').innerText = c.question;
                    document.getElementById('fc-back').innerText = c.answer;
                    document.getElementById('flashcard-counter').innerText = `${this.currentIndex+1}/${this.data.length}`;
                }, 200);
            },
            flipCard: function() { document.getElementById('flashcard-inner').classList.toggle('rotate-y-180'); },
            nextFlashcard: function() { if(this.currentIndex<this.data.length-1) {this.currentIndex++; this.renderFlashcard();} },
            prevFlashcard: function() { if(this.currentIndex>0) {this.currentIndex--; this.renderFlashcard();} },
            shuffleFlashcards: function() { 
                this.data.sort(() => Math.random() - 0.5); 
                this.currentIndex=0; this.renderFlashcard(); 
                this.showToast("Kartu Diacak!");
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
